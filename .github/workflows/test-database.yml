name: Test GeoLite2 Database

on:
  # 在 Release 创建后运行测试
  release:
    types: [published]

  # 允许手动触发
  workflow_dispatch:

jobs:
  test-database:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Download latest database from release
        run: |
          echo "Searching for GeoLite2 database..."

          # 首先检查是否是由 release 触发的
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "Triggered by release event"
            RELEASE_TAG="${{ github.event.release.tag_name }}"

            # 检查是否是 GeoLite2 release
            if [[ "$RELEASE_TAG" == geolite2-* ]] || [[ "$RELEASE_TAG" =~ ^[0-9]{8}$ ]]; then
              echo "This is a GeoLite2 release: $RELEASE_TAG"
              # 直接从 API 获取 release 信息
              LATEST_RELEASE=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/$RELEASE_TAG)
            else
              echo "This is not a GeoLite2 release (tag: $RELEASE_TAG), skipping test"
              exit 0
            fi
          else
            echo "Manual trigger, searching for latest GeoLite2 release..."
            # 查找最新的 GeoLite2 release (新格式)
            LATEST_RELEASE=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases | jq -r '[.[] | select(.tag_name | startswith("geolite2-"))] | first')

            # 如果没找到，尝试旧格式（纯日期）
            if [ "$LATEST_RELEASE" == "null" ] || [ -z "$LATEST_RELEASE" ]; then
              echo "No new format release found, trying legacy format..."
              LATEST_RELEASE=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases | jq -r '[.[] | select(.tag_name | test("^[0-9]{8}$"))] | first')
            fi

            if [ "$LATEST_RELEASE" == "null" ] || [ -z "$LATEST_RELEASE" ]; then
              echo "⚠️ No GeoLite2 release found in repository"
              echo "This is expected if GeoLite2 workflow hasn't run yet"
              echo "Skipping test..."
              exit 0
            fi
          fi

          RELEASE_TAG=$(echo "$LATEST_RELEASE" | jq -r '.tag_name')
          echo "Using release: $RELEASE_TAG"

          # 显示可用的资源文件（用于调试）
          echo "Available assets in release:"
          echo "$LATEST_RELEASE" | jq -r '.assets[].name'
          echo ""

          # 查找 GeoLite2-City 文件（优先查找带日期的新格式）
          CITY_URL=$(echo "$LATEST_RELEASE" | jq -r '.assets[] | select(.name | startswith("GeoLite2-City")) | .browser_download_url' | head -n 1)
          CITY_NAME=$(echo "$LATEST_RELEASE" | jq -r '.assets[] | select(.name | startswith("GeoLite2-City")) | .name' | head -n 1)

          if [ -n "$CITY_URL" ] && [ "$CITY_URL" != "null" ]; then
            echo "Found database: $CITY_NAME"
            echo "Downloading from: $CITY_URL"
            curl -L -o GeoLite2-City.mmdb "$CITY_URL"

            if [ -f "GeoLite2-City.mmdb" ]; then
              echo "✓ Downloaded successfully"
            else
              echo "❌ Download failed"
              exit 1
            fi
          else
            echo "❌ GeoLite2-City database not found in release"
            echo "Please check if the release contains the database file"
            exit 1
          fi

      - name: Install dependencies
        run: go mod tidy

      - name: Run tests
        run: |
          echo "Running GeoLite2 database tests..."

          # 检查是否存在测试文件
          if [ -f "examples/test/test_cities.go" ]; then
            echo "Running examples/test/test_cities.go..."
            cd examples/test
            go run test_cities.go
            cd ../..
          elif [ -f "examples/query/main.go" ]; then
            echo "Running examples/query/main.go..."
            cd examples/query
            go run main.go
            cd ../..
          else
            echo "No test files found"
            exit 1
          fi

          echo ""
          echo "✓ GeoLite2 database test completed successfully"

      - name: Verify database integrity
        run: |
          if [ -f "GeoLite2-City.mmdb" ]; then
            FILE_SIZE=$(du -h GeoLite2-City.mmdb | cut -f1)
            echo "✓ Database verified (Size: $FILE_SIZE)"

            # 显示文件信息
            echo ""
            echo "Database file details:"
            ls -lh GeoLite2-City.mmdb
          else
            echo "✗ Database file not found"
            exit 1
          fi

      - name: Test summary
        if: success()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✓ GeoLite2 Database Test Summary"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Status: PASSED ✓"
          echo "Database: GeoLite2 City"
          echo "Test Date: $(date +'%Y-%m-%d %H:%M:%S UTC')"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      - name: Notify on failure
        if: failure()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "⚠️ GeoLite2 Database Test Failed"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Please check the logs above for details"
          echo "Common issues:"
          echo "  - Database file not found in release"
          echo "  - MaxMind License Key issues"
          echo "  - Network connection problems"
          echo "  - Database format issues"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
