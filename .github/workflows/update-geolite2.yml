name: Update GeoLite2 Database

on:
  # æ¯å‘¨äºŒå’Œå‘¨äº” UTC æ—¶é—´ 10:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 18:00ï¼‰
  schedule:
    - cron: '0 10 * * 2,5'

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  update-database:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download GeoLite2-City database
        env:
          MAXMIND_LICENSE_KEY: ${{ secrets.MAXMIND_LICENSE_KEY }}
        run: |
          echo "Downloading GeoLite2-City database..."
          curl -L -o GeoLite2-City.tar.gz \
            "https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-City&license_key=${MAXMIND_LICENSE_KEY}&suffix=tar.gz"

          # è§£å‹æ–‡ä»¶
          tar -xzf GeoLite2-City.tar.gz

          # æŸ¥æ‰¾å¹¶ç§»åŠ¨ .mmdb æ–‡ä»¶
          find . -name "GeoLite2-City.mmdb" -exec mv {} ./ \;

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf GeoLite2-City_* GeoLite2-City.tar.gz

      - name: Download GeoLite2-Country database
        env:
          MAXMIND_LICENSE_KEY: ${{ secrets.MAXMIND_LICENSE_KEY }}
        run: |
          echo "Downloading GeoLite2-Country database..."
          curl -L -o GeoLite2-Country.tar.gz \
            "https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-Country&license_key=${MAXMIND_LICENSE_KEY}&suffix=tar.gz"

          # è§£å‹æ–‡ä»¶
          tar -xzf GeoLite2-Country.tar.gz

          # æŸ¥æ‰¾å¹¶ç§»åŠ¨ .mmdb æ–‡ä»¶
          find . -name "GeoLite2-Country.mmdb" -exec mv {} ./ \;

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf GeoLite2-Country_* GeoLite2-Country.tar.gz

      - name: Download GeoLite2-ASN database
        env:
          MAXMIND_LICENSE_KEY: ${{ secrets.MAXMIND_LICENSE_KEY }}
        run: |
          echo "Downloading GeoLite2-ASN database..."
          curl -L -o GeoLite2-ASN.tar.gz \
            "https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-ASN&license_key=${MAXMIND_LICENSE_KEY}&suffix=tar.gz"

          # è§£å‹æ–‡ä»¶
          tar -xzf GeoLite2-ASN.tar.gz

          # æŸ¥æ‰¾å¹¶ç§»åŠ¨ .mmdb æ–‡ä»¶
          find . -name "GeoLite2-ASN.mmdb" -exec mv {} ./ \;

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf GeoLite2-ASN_* GeoLite2-ASN.tar.gz

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Rename files with date
        run: |
          DATE=$(date +'%Y%m%d')
          mv GeoLite2-City.mmdb GeoLite2-City-${DATE}.mmdb
          mv GeoLite2-Country.mmdb GeoLite2-Country-${DATE}.mmdb
          mv GeoLite2-ASN.mmdb GeoLite2-ASN-${DATE}.mmdb

      - name: Check if databases were downloaded
        id: check
        run: |
          DATE=$(date +'%Y%m%d')
          CITY_FILE="GeoLite2-City-${DATE}.mmdb"
          COUNTRY_FILE="GeoLite2-Country-${DATE}.mmdb"
          ASN_FILE="GeoLite2-ASN-${DATE}.mmdb"

          if [ -f "$CITY_FILE" ] && [ -f "$COUNTRY_FILE" ] && [ -f "$ASN_FILE" ]; then
            echo "Database files found"
            echo "success=true" >> $GITHUB_OUTPUT

            # è·å–æ–‡ä»¶å¤§å°
            CITY_SIZE=$(du -h "$CITY_FILE" | cut -f1)
            COUNTRY_SIZE=$(du -h "$COUNTRY_FILE" | cut -f1)
            ASN_SIZE=$(du -h "$ASN_FILE" | cut -f1)

            echo "city_size=${CITY_SIZE}" >> $GITHUB_OUTPUT
            echo "country_size=${COUNTRY_SIZE}" >> $GITHUB_OUTPUT
            echo "asn_size=${ASN_SIZE}" >> $GITHUB_OUTPUT

            echo "city_file=${CITY_FILE}" >> $GITHUB_OUTPUT
            echo "country_file=${COUNTRY_FILE}" >> $GITHUB_OUTPUT
            echo "asn_file=${ASN_FILE}" >> $GITHUB_OUTPUT
          else
            echo "Database files not found"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Create Release
        if: steps.check.outputs.success == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: geolite2-${{ steps.date.outputs.date }}
          name: GeoLite2 Database - ${{ steps.date.outputs.date }}
          body: |
            ## GeoLite2 æ•°æ®åº“æ›´æ–°

            **æ›´æ–°æ—¥æœŸ**: ${{ steps.date.outputs.date }}

            ### ğŸ“¦ åŒ…å«æ–‡ä»¶

            - **${{ steps.check.outputs.city_file }}** (${{ steps.check.outputs.city_size }}) - åŸå¸‚çº§åˆ« IP åœ°ç†ä½ç½®æ•°æ®åº“
            - **${{ steps.check.outputs.country_file }}** (${{ steps.check.outputs.country_size }}) - å›½å®¶çº§åˆ« IP åœ°ç†ä½ç½®æ•°æ®åº“
            - **${{ steps.check.outputs.asn_file }}** (${{ steps.check.outputs.asn_size }}) - ASN æ•°æ®åº“

            ### ğŸ“ ä½¿ç”¨è¯´æ˜

            1. ä¸‹è½½æ‰€éœ€çš„ `.mmdb` æ–‡ä»¶
            2. å°†æ–‡ä»¶æ”¾ç½®åœ¨ä½ çš„é¡¹ç›®ç›®å½•ä¸­
            3. ä½¿ç”¨ MaxMind GeoIP2 åº“è¯»å–æ•°æ®åº“

            ### ğŸ”— ç›¸å…³é“¾æ¥

            - [MaxMind GeoLite2 å®˜æ–¹æ–‡æ¡£](https://dev.maxmind.com/geoip/geolite2-free-geolocation-data)
            - [é¡¹ç›®ä»“åº“](https://github.com/${{ github.repository }})

            ### âš ï¸ æ³¨æ„äº‹é¡¹

            æœ¬æ•°æ®åº“ç”± MaxMind æä¾›ï¼Œéµå¾ª [GeoLite2 æœ€ç»ˆç”¨æˆ·è®¸å¯åè®®](https://www.maxmind.com/en/geolite2/eula)ã€‚
            æ•°æ®åº“æ¯å‘¨æ›´æ–°ä¸¤æ¬¡ï¼ˆå‘¨äºŒå’Œå‘¨äº”ï¼‰ã€‚

            ---

            *æ­¤ Release ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*
          files: |
            ${{ steps.check.outputs.city_file }}
            ${{ steps.check.outputs.country_file }}
            ${{ steps.check.outputs.asn_file }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GEOIP_ACCESS_TOKEN }}

      - name: Notify on failure
        if: failure()
        run: |
          echo "âš ï¸ æ•°æ®åº“æ›´æ–°å¤±è´¥"
          echo "è¯·æ£€æŸ¥ MaxMind License Key æ˜¯å¦æ­£ç¡®"
          echo "æˆ–è®¿é—® MaxMind ç½‘ç«™ç¡®è®¤æ•°æ®åº“æ˜¯å¦å¯ç”¨"
