name: Test DB-IP Database

on:
  # 在 Release 创建后运行测试
  release:
    types: [published]

  # 允许手动触发
  workflow_dispatch:

jobs:
  test-database:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Download latest DB-IP database from release
        run: |
          echo "Searching for DB-IP database..."

          # 首先检查是否是由 release 触发的
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "Triggered by release event"
            RELEASE_TAG="${{ github.event.release.tag_name }}"

            # 检查是否是 DB-IP release
            if [[ "$RELEASE_TAG" == dbip-* ]]; then
              echo "This is a DB-IP release: $RELEASE_TAG"
              # 直接从 API 获取 release 信息
              LATEST_RELEASE=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/$RELEASE_TAG)
            else
              echo "This is not a DB-IP release (tag: $RELEASE_TAG), skipping test"
              exit 0
            fi
          else
            echo "Manual trigger, searching for latest DB-IP release..."
            # 查找最新的 DB-IP release
            LATEST_RELEASE=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases | jq -r '[.[] | select(.tag_name | startswith("dbip-"))] | first')

            if [ "$LATEST_RELEASE" == "null" ] || [ -z "$LATEST_RELEASE" ]; then
              echo "⚠️ No DB-IP release found in repository"
              echo "This is expected if DB-IP workflow hasn't run yet"
              echo "Skipping test..."
              exit 0
            fi
          fi

          RELEASE_TAG=$(echo "$LATEST_RELEASE" | jq -r '.tag_name')
          echo "Using release: $RELEASE_TAG"

          # 显示可用的资源文件（用于调试）
          echo "Available assets in release:"
          echo "$LATEST_RELEASE" | jq -r '.assets[].name'
          echo ""

          # 查找 DB-IP City Lite 文件（支持 dbip-city-lite-YYYY-MM.mmdb 格式）
          CITY_URL=$(echo "$LATEST_RELEASE" | jq -r '.assets[] | select(.name | startswith("dbip-city-lite")) | .browser_download_url' | head -n 1)
          CITY_NAME=$(echo "$LATEST_RELEASE" | jq -r '.assets[] | select(.name | startswith("dbip-city-lite")) | .name' | head -n 1)

          if [ -n "$CITY_URL" ] && [ "$CITY_URL" != "null" ]; then
            echo "Found database: $CITY_NAME"
            echo "Downloading from: $CITY_URL"
            # 下载 DB-IP 数据库文件
            # 注意: DB-IP 数据库与 MaxMind GeoIP2 格式兼容，可以使用相同的读取库
            curl -L -o "$CITY_NAME" "$CITY_URL"

            if [ -f "$CITY_NAME" ]; then
              echo "✓ Downloaded successfully: $CITY_NAME"
              # 保存文件名到文件，供后续步骤使用
              echo "$CITY_NAME" > db_filename.txt
            else
              echo "❌ Download failed"
              exit 1
            fi
          else
            echo "❌ DB-IP City database not found in release"
            echo "Please check if the release contains the database file"
            exit 1
          fi

      - name: Install dependencies
        run: go mod tidy

      - name: Run tests
        run: |
          echo "Running DB-IP database tests..."

          # 读取数据库文件名
          DB_FILE=$(cat db_filename.txt)
          echo "Database file: $DB_FILE"
          echo ""

          # 检查是否存在测试文件
          if [ -f "examples/test/test_cities.go" ]; then
            echo "Running examples/test/test_cities.go..."
            cd examples/test
            # 通过环境变量传递数据库路径（DB-IP 数据库格式兼容 GeoIP2）
            GEOIP_DB_PATH="../../$DB_FILE" go run test_cities.go
            cd ../..
          elif [ -f "examples/query/main.go" ]; then
            echo "Running examples/query/main.go..."
            cd examples/query
            # 通过环境变量传递数据库路径（DB-IP 数据库格式兼容 GeoIP2）
            GEOIP_DB_PATH="../../$DB_FILE" go run main.go
            cd ../..
          else
            echo "No test files found"
            exit 1
          fi

          echo ""
          echo "✓ DB-IP database test completed successfully"

      - name: Verify database integrity
        run: |
          # 读取数据库文件名
          DB_FILE=$(cat db_filename.txt)

          if [ -f "$DB_FILE" ]; then
            FILE_SIZE=$(du -h "$DB_FILE" | cut -f1)
            echo "✓ Database verified (Size: $FILE_SIZE)"

            # 显示文件信息
            echo ""
            echo "Database file details:"
            ls -lh "$DB_FILE"
          else
            echo "✗ Database file not found: $DB_FILE"
            exit 1
          fi

      - name: Test summary
        if: success()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✓ DB-IP Database Test Summary"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Status: PASSED ✓"
          echo "Database: DB-IP City Lite"
          echo "Test Date: $(date +'%Y-%m-%d %H:%M:%S UTC')"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      - name: Notify on failure
        if: failure()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "⚠️ DB-IP Database Test Failed"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Please check the logs above for details"
          echo "Common issues:"
          echo "  - Database file not found in release"
          echo "  - Network connection problems"
          echo "  - Database format issues"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
