name: Update DB-IP Database

on:
  # æ¯æœˆ1å·å’Œ15å· UTC æ—¶é—´ 10:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 18:00ï¼‰
  schedule:
    - cron: '0 10 1,15 * *'

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  update-database:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download DB-IP City Lite database
        run: |
          echo "Downloading DB-IP City Lite database..."
          # ä¸‹è½½æœ€æ–°çš„å…è´¹ç‰ˆæœ¬
          curl -L -o dbip-city-lite.mmdb.gz \
            "https://download.db-ip.com/free/dbip-city-lite-$(date +%Y-%m).mmdb.gz"

          # è§£å‹æ–‡ä»¶
          gunzip dbip-city-lite.mmdb.gz

          # é‡å‘½åä¸ºæ ‡å‡†æ ¼å¼
          mv dbip-city-lite.mmdb dbip-city-lite-$(date +%Y-%m).mmdb

      - name: Download DB-IP Country Lite database
        run: |
          echo "Downloading DB-IP Country Lite database..."
          # ä¸‹è½½æœ€æ–°çš„å…è´¹ç‰ˆæœ¬
          curl -L -o dbip-country-lite.mmdb.gz \
            "https://download.db-ip.com/free/dbip-country-lite-$(date +%Y-%m).mmdb.gz"

          # è§£å‹æ–‡ä»¶
          gunzip dbip-country-lite.mmdb.gz

          # é‡å‘½åä¸ºæ ‡å‡†æ ¼å¼
          mv dbip-country-lite.mmdb dbip-country-lite-$(date +%Y-%m).mmdb

      - name: Download DB-IP ASN Lite database
        run: |
          echo "Downloading DB-IP ASN Lite database..."
          # ä¸‹è½½æœ€æ–°çš„å…è´¹ç‰ˆæœ¬
          curl -L -o dbip-asn-lite.mmdb.gz \
            "https://download.db-ip.com/free/dbip-asn-lite-$(date +%Y-%m).mmdb.gz"

          # è§£å‹æ–‡ä»¶
          gunzip dbip-asn-lite.mmdb.gz

          # é‡å‘½åä¸ºæ ‡å‡†æ ¼å¼
          mv dbip-asn-lite.mmdb dbip-asn-lite-$(date +%Y-%m).mmdb

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Get year-month for filename
        id: yearmonth
        run: echo "yearmonth=$(date +'%Y-%m')" >> $GITHUB_OUTPUT

      - name: Check if databases were downloaded
        id: check
        run: |
          CITY_FILE="dbip-city-lite-${{ steps.yearmonth.outputs.yearmonth }}.mmdb"
          COUNTRY_FILE="dbip-country-lite-${{ steps.yearmonth.outputs.yearmonth }}.mmdb"
          ASN_FILE="dbip-asn-lite-${{ steps.yearmonth.outputs.yearmonth }}.mmdb"

          if [ -f "$CITY_FILE" ] && [ -f "$COUNTRY_FILE" ] && [ -f "$ASN_FILE" ]; then
            echo "Database files found"
            echo "success=true" >> $GITHUB_OUTPUT

            # è·å–æ–‡ä»¶å¤§å°
            CITY_SIZE=$(du -h "$CITY_FILE" | cut -f1)
            COUNTRY_SIZE=$(du -h "$COUNTRY_FILE" | cut -f1)
            ASN_SIZE=$(du -h "$ASN_FILE" | cut -f1)

            echo "city_size=${CITY_SIZE}" >> $GITHUB_OUTPUT
            echo "country_size=${COUNTRY_SIZE}" >> $GITHUB_OUTPUT
            echo "asn_size=${ASN_SIZE}" >> $GITHUB_OUTPUT

            echo "city_file=${CITY_FILE}" >> $GITHUB_OUTPUT
            echo "country_file=${COUNTRY_FILE}" >> $GITHUB_OUTPUT
            echo "asn_file=${ASN_FILE}" >> $GITHUB_OUTPUT
          else
            echo "Database files not found"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Create Release
        if: steps.check.outputs.success == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: dbip-${{ steps.date.outputs.date }}
          name: DB-IP Database - ${{ steps.date.outputs.date }}
          body: |
            ## DB-IP æ•°æ®åº“æ›´æ–°

            **æ›´æ–°æ—¥æœŸ**: ${{ steps.date.outputs.date }}
            **æ•°æ®åº“æœˆä»½**: ${{ steps.yearmonth.outputs.yearmonth }}

            ### ğŸ“¦ åŒ…å«æ–‡ä»¶

            - **${{ steps.check.outputs.city_file }}** (${{ steps.check.outputs.city_size }}) - åŸå¸‚çº§åˆ« IP åœ°ç†ä½ç½®æ•°æ®åº“
            - **${{ steps.check.outputs.country_file }}** (${{ steps.check.outputs.country_size }}) - å›½å®¶çº§åˆ« IP åœ°ç†ä½ç½®æ•°æ®åº“
            - **${{ steps.check.outputs.asn_file }}** (${{ steps.check.outputs.asn_size }}) - ASN æ•°æ®åº“

            ### ğŸ“ ä½¿ç”¨è¯´æ˜

            1. ä¸‹è½½æ‰€éœ€çš„ `.mmdb` æ–‡ä»¶
            2. å°†æ–‡ä»¶æ”¾ç½®åœ¨ä½ çš„é¡¹ç›®ç›®å½•ä¸­
            3. ä½¿ç”¨å…¼å®¹ MaxMind DB æ ¼å¼çš„åº“è¯»å–æ•°æ®åº“ï¼ˆå¦‚ MaxMind GeoIP2 åº“ï¼‰

            ### ğŸ”— ç›¸å…³é“¾æ¥

            - [DB-IP å®˜æ–¹ç½‘ç«™](https://db-ip.com/)
            - [DB-IP å…è´¹æ•°æ®åº“](https://db-ip.com/db/download/ip-to-city-lite)
            - [é¡¹ç›®ä»“åº“](https://github.com/${{ github.repository }})

            ### âš ï¸ æ³¨æ„äº‹é¡¹

            - æœ¬æ•°æ®åº“ç”± DB-IP æä¾›ï¼Œä½¿ç”¨ [Creative Commons Attribution 4.0 International License](https://creativecommons.org/licenses/by/4.0/) æˆæƒ
            - å…è´¹ç‰ˆæœ¬æ•°æ®åº“æ¯æœˆæ›´æ–°ä¸€æ¬¡
            - DB-IP æ•°æ®åº“ä¸ MaxMind GeoIP2 æ ¼å¼å…¼å®¹ï¼Œå¯ä»¥ä½¿ç”¨ç›¸åŒçš„è¯»å–åº“

            ### ğŸ“Š DB-IP vs GeoLite2

            - **ä¼˜åŠ¿**: DB-IP æä¾›æ›´è‡ªç”±çš„æˆæƒåè®®ï¼ˆCC BY 4.0ï¼‰
            - **æ›´æ–°é¢‘ç‡**: å…è´¹ç‰ˆæ¯æœˆæ›´æ–°ï¼ˆMaxMind GeoLite2 æ¯å‘¨æ›´æ–°ä¸¤æ¬¡ï¼‰
            - **å‡†ç¡®æ€§**: ä¸¤è€…å‡†ç¡®æ€§ç›¸å½“ï¼Œå…·ä½“å–å†³äºåœ°åŒº

            ---

            *æ­¤ Release ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*
          files: |
            ${{ steps.check.outputs.city_file }}
            ${{ steps.check.outputs.country_file }}
            ${{ steps.check.outputs.asn_file }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GEOIP_ACCESS_TOKEN }}

      - name: Notify on failure
        if: failure()
        run: |
          echo "âš ï¸ DB-IP æ•°æ®åº“æ›´æ–°å¤±è´¥"
          echo "è¯·æ£€æŸ¥ DB-IP ä¸‹è½½é“¾æ¥æ˜¯å¦å¯ç”¨"
          echo "æˆ–è®¿é—® https://db-ip.com ç¡®è®¤æ•°æ®åº“æ˜¯å¦å¯ç”¨"
